<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner</title>
    <style>
        main {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
        }
        #reader {
            width: 600px;
        }
        #result, #output {
            text-align: center;
            font-size: 1.5rem;
        }
        #connection-status {
            margin-top: 20px;
            font-size: 1.2rem;
        }
        .connected {
            color: green;
        }
        .disconnected {
            color: red;
        }
    </style>
</head>
<body data-rsssl="1">
    <main>
        <div id="reader"></div>
        <div id="result"></div>
        <div id="connection-status" class="disconnected">NON CONNESSO</div>
        <label>Data:</label> <input type="text" id="date" readonly><br>
        <label>Orario:</label> <input type="text" id="time" readonly><br>
        <label>Testo:</label> <input type="text" id="text" maxlength="20" readonly><br>
        <label>Lettera:</label> <input type="text" id="letter" maxlength="1" readonly><br>
        <label>TABLE:</label> <input type="text" id="table" maxlength="10"><br>
        <button id="sendData">Invia Dati</button>
        <button id="newScan">New Scan</button>
        <br>
        <label>Stringa da inviare:</label> <input type="text" id="output" readonly><br>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js" integrity="sha512-k/KAe4Yff9EUdYI5/IAHlwUswqeipP+Cp5qnrsUjTPCgl51La2/JhyyjNciztD7mWNKLSXci48m7cctATKfLlQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        const serverUrl = 'http://192.168.178.53:5000/receive_data';

        function checkConnection() {
            fetch(serverUrl, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                updateConnectionStatus(response.ok);
            })
            .catch(() => {
                updateConnectionStatus(false);
            });
        }

        function updateConnectionStatus(isConnected) {
            const statusElement = document.getElementById('connection-status');
            statusElement.textContent = isConnected ? 'CONNESSO' : 'NON CONNESSO';
            statusElement.classList.toggle('connected', isConnected);
            statusElement.classList.toggle('disconnected', !isConnected);
        }

        const scanner = new Html5QrcodeScanner('reader', { qrbox: { width: 250, height: 250 }, fps: 20 });
        scanner.render(onScanSuccess, console.error);

        function onScanSuccess(result) {
            const parts = result.split(";");
            if (parts.length === 6 && parts[0] === "INI" && parts[5] === "END") {
                document.getElementById("date").value = parts[1];
                document.getElementById("time").value = parts[2];
                document.getElementById("text").value = parts[3];
                document.getElementById("letter").value = parts[4];
                scanner.clear();
            } else {
                alert("Formato QR code non valido");
            }
        }

        document.getElementById("sendData").addEventListener("click", function() {
            const date = document.getElementById("date").value;
            const time = document.getElementById("time").value;
            const text = document.getElementById("text").value;
            const letter = document.getElementById("letter").value;
            const table = document.getElementById("table").value;
            
            if (!date || !time || !text || !letter || !table) {
                alert("Compila tutti i campi!");
                return;
            }
            
            const dataString = `${date};${time};${text};${letter};${table}`;
            document.getElementById("output").value = dataString;
            
            fetch(serverUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ data: dataString })
            })
            .then(response => response.text())
            .then(data => alert("Dati inviati con successo: " + data))
            .catch(error => alert("Errore nell'invio dei dati: " + error));
        });

        document.getElementById("newScan").addEventListener("click", function() {
            location.reload();
        });

        setInterval(checkConnection, 5000);
        checkConnection();
    </script>
</body>
</html>
